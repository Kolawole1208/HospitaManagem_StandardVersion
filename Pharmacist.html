<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --primary-light: #a29bfe;
            --primary-dark: #4a3fbf;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --danger-color: #d63031;
            --info-color: #0984e3;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            margin-bottom: 20px;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .card-primary {
            border-left: 5px solid var(--primary-color);
        }

        .card-success {
            border-left: 5px solid var(--success-color);
        }

        .card-warning {
            border-left: 5px solid var(--warning-color);
        }

        .card-danger {
            border-left: 5px solid var(--danger-color);
        }

        .card-title {
            color: var--primary-color;
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .action-btn {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-edit {
            background-color: #2196F3;
            color: white;
        }

        .btn-edit:hover {
            background-color: #0b7dda;
        }

        .btn-delete {
            background-color: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background-color: #d32f2f;
        }

        .btn-process {
            background-color: #4CAF50;
            color: white;
        }

        .btn-process:hover {
            background-color: #388E3C;
        }

        .select2-container--default .select2-selection--multiple {
            min-height: 38px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: var(--primary-color);
            border: none;
            border-radius: 4px;
            color: white;
            padding: 2px 8px;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: white;
            margin-right: 5px;
        }

        .receipt {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--box-shadow);
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 10px;
        }

        .receipt-footer {
            margin-top: 20px;
            border-top: 1px dashed #ddd;
            padding-top: 10px;
            text-align: right;
            font-weight: bold;
        }

        .drug-tag {
            display: inline-block;
            background-color: #f0f0f0;
            padding: 3px 8px;
            border-radius: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }

        .drug-tag .price {
            color: var(--success-color);
            font-weight: bold;
            margin-left: 5px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .modal-title {
            margin: 0;
            color: var(--primary-color);
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: inherit;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Drug items table */
        .drug-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .drug-items-table th {
            background-color: #f8f9fa;
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .drug-items-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .drug-items-table input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .drug-items-table .remove-drug {
            color: var(--danger-color);
            cursor: pointer;
        }

        /* Delete Confirmation Modal */
        .confirm-modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .confirm-content {
            background-color: #fefefe;
            margin: 20% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 40%;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .confirm-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 90%;
            }

            .confirm-content {
                width: 80%;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }

        @media (max-width: 480px) {
            .confirm-content {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-prescription-bottle-alt"></i> Pharmacy Management</h1>
        </div>
    </div>

    <div class="container">
        <!-- Dashboard Cards -->
        <div class="row">
            <div class="col-md-3">
                <div class="card card-primary">
                    <div class="card-body">
                        <h5 class="card-title">Total Drugs</h5>
                        <p class="card-text fs-4" id="totalDrugs">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-success">
                    <div class="card-body">
                        <h5 class="card-title">Today's Sales</h5>
                        <p class="card-text fs-4" id="todaySales">₦0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-warning">
                    <div class="card-body">
                        <h5 class="card-title">Low Stock</h5>
                        <p class="card-text fs-4" id="lowStock">0</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-danger">
                    <div class="card-body">
                        <h5 class="card-title">Pending Orders</h5>
                        <p class="card-text fs-4" id="pendingOrders">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pharmacy Actions -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title">Pharmacy Transactions</h5>
                            <button class="btn btn-primary" id="addTransactionBtn"><i class="fas fa-plus"></i> New Transaction</button>
                        </div>
                        <div class="search-box mt-3">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search transactions...">
                        </div>
                        <div class="table-responsive mt-3">
                            <table class="table table-hover" id="pharmacyTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Buyer Name</th>
                                        <th>Drugs Purchased</th>
                                        <th>Total Amount</th>
                                        <th>Processed By</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Transactions will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drug Inventory -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title">Drug Inventory</h5>
                            <button class="btn btn-primary" id="addDrugBtn"><i class="fas fa-plus"></i> Add Drug</button>
                        </div>
                        <div class="table-responsive mt-3">
                            <table class="table table-hover" id="inventoryTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Drug Name</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Price (₦)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Inventory will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales Chart -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Sales Analytics</h5>
                        <canvas id="salesChart" height="100"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="transactionModalTitle">New Pharmacy Transaction</h2>
                <span class="close">&times;</span>
            </div>
            <form id="transactionForm">
                <input type="hidden" id="transactionId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="buyerName">Buyer Name</label>
                        <input type="text" id="buyerName" required>
                    </div>
                    <div class="form-group">
                        <label for="processedBy">Processed By</label>
                        <select id="processedBy" required>
                            <option value="">Select Staff</option>
                            <option value="Pharmacist">Pharmacist</option>
                            <option value="Pharmacy Technician">Pharmacy Technician</option>
                            <option value="Pharmacy Services">Pharmacy Services / Hospital Pharmacy</option>
                            <option value="Medical Inventory">Medical Inventory / Supply Chain Team</option>
                            <option value="Pharmacy Informatics">Pharmacy Informatics / Clinical Pharmacists</option>
                            <option value="Pharmacy Manager">Pharmacy Manager / Director of Pharmacy</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="drugs">Select Drugs (2-15)</label>
                    <select id="drugs" class="drug-select" multiple="multiple" required>
                        <!-- Drugs will be populated from inventory -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Selected Drugs with Quantities</label>
                    <div id="selectedDrugsContainer">
                        <table class="drug-items-table">
                            <thead>
                                <tr>
                                    <th>Drug Name</th>
                                    <th>Quantity</th>
                                    <th>Unit Price (₦)</th>
                                    <th>Subtotal (₦)</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="selectedDrugsList">
                                <!-- Selected drugs with quantities will appear here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="totalAmount">Total Amount (₦)</label>
                        <input type="number" id="totalAmount" readonly>
                    </div>
                    <div class="form-group">
                        <label for="transactionDate">Date</label>
                        <input type="date" id="transactionDate" required>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelTransactionBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveTransactionBtn">Process Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Drug Modal -->
    <div id="drugModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="drugModalTitle">Add New Drug</h2>
                <span class="close">&times;</span>
            </div>
            <form id="drugForm">
                <input type="hidden" id="drugId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="drugName">Drug Name</label>
                        <input type="text" id="drugName" required>
                    </div>
                    <div class="form-group">
                        <label for="drugCategory">Category</label>
                        <select id="drugCategory" required>
                            <option value="">Select Category</option>
                            <option value="Analgesics">Analgesics</option>
                            <option value="Antibiotics">Antibiotics</option>
                            <option value="Antihypertensives">Antihypertensives</option>
                            <option value="Antidiabetics">Antidiabetics</option>
                            <option value="Vitamins">Vitamins</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="drugQuantity">Quantity</label>
                        <input type="number" id="drugQuantity" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="drugPrice">Price (₦)</label>
                        <input type="number" id="drugPrice" min="0" step="0.01" required>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelDrugBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveDrugBtn">Save Drug</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Transaction Receipt</h2>
                <span class="close">&times;</span>
            </div>
            <div class="receipt" id="receiptContent">
                <!-- Receipt content will be generated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeReceiptBtn">Close</button>
                <button type="button" class="btn btn-primary" id="printReceiptBtn"><i class="fas fa-print"></i> Print</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-content">
            <span class="close" id="confirmClose">&times;</span>
            <h2>Confirm Delete</h2>
            <p>Are you sure you want to delete this record?</p>
            <div class="confirm-buttons">
                <button class="btn btn-secondary" id="confirmCancel">Cancel</button>
                <button class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // DOM Elements
        const addTransactionBtn = document.getElementById('addTransactionBtn');
        const addDrugBtn = document.getElementById('addDrugBtn');
        const transactionModal = document.getElementById('transactionModal');
        const drugModal = document.getElementById('drugModal');
        const receiptModal = document.getElementById('receiptModal');
        const confirmModal = document.getElementById('confirmModal');
        const closeBtns = document.querySelectorAll('.close');
        const cancelTransactionBtn = document.getElementById('cancelTransactionBtn');
        const cancelDrugBtn = document.getElementById('cancelDrugBtn');
        const closeReceiptBtn = document.getElementById('closeReceiptBtn');
        const printReceiptBtn = document.getElementById('printReceiptBtn');
        const confirmCancel = document.getElementById('confirmCancel');
        const transactionForm = document.getElementById('transactionForm');
        const drugForm = document.getElementById('drugForm');
        const pharmacyTable = document.getElementById('pharmacyTable').getElementsByTagName('tbody')[0];
        const inventoryTable = document.getElementById('inventoryTable').getElementsByTagName('tbody')[0];
        const searchInput = document.getElementById('searchInput');
        
        // Summary counters
        const totalDrugs = document.getElementById('totalDrugs');
        const todaySales = document.getElementById('todaySales');
        const lowStock = document.getElementById('lowStock');
        const pendingOrders = document.getElementById('pendingOrders');
        
        // Variables
        let nextTransactionId = 3; // Start from 3 since we have sample transactions
        let nextDrugId = 7; // Start from 7 since we have sample drugs
        let currentRow = null;
        let currentDrugRow = null;
        let isEditMode = false;
        let recordToDelete = null;
        let drugInventory = [];
        let pharmacyTransactions = [];
        let selectedDrugs = [];
        let totalAmount = 0;
        let lastTransactionId = null; // Track the last transaction ID

        // Initialize Select2 for drug selection
        $(document).ready(function() {
            $('.drug-select').select2({
                placeholder: "Select 2-15 drugs",
                maximumSelectionLength: 15,
                minimumSelectionLength: 2
            });
        });

        // Sample initial data
        function initializeSampleData() {
            // Sample drugs
            drugInventory = [
                { id: 'DR001', name: 'Paracetamol', category: 'Analgesics', quantity: 100, price: 300 },
                { id: 'DR002', name: 'Amoxicillin', category: 'Antibiotics', quantity: 50, price: 500 },
                { id: 'DR003', name: 'Ibuprofen', category: 'Analgesics', quantity: 75, price:600 },
                { id: 'DR004', name: 'Losartan', category: 'Antihypertensives', quantity: 30, price: 1000 },
                { id: 'DR005', name: 'Metformin', category: 'Antidiabetics', quantity: 40, price: 1500 },
                { id: 'DR006', name: 'Vitamin C', category: 'Vitamins', quantity: 200, price: 600 }
            ];
            
            // Sample transactions
            pharmacyTransactions = [
                { 
                    id: 'TR001', 
                    buyerName: 'John Doe', 
                    drugs: [
                        { id: 'DR001', name: 'Paracetamol', quantity: 2, price: 300 },
                        { id: 'DR003', name: 'Ibuprofen', quantity: 1, price: 600 }
                    ], 
                    totalAmount: 180, 
                    processedBy: 'Pharmacist', 
                    date: '2025-08-10', 
                    status: 'Completed' 
                },
                { 
                    id: 'TR002', 
                    buyerName: 'Jane Smith', 
                    drugs: [
                        { id: 'DR002', name: 'Amoxicillin', quantity: 1, price: 500 },
                        { id: 'DR005', name: 'Metformin', quantity: 3, price: 1500 }
                    ], 
                    totalAmount: 390, 
                    processedBy: 'Pharmacy Technician', 
                    date: '2025-08-09', 
                    status: 'Completed' 
                }
            ];
            
            updateInventoryTable();
            updatePharmacyTable();
            updateSummaryCounters();
            populateDrugSelect();
        }

        // Update inventory table
        function updateInventoryTable() {
            inventoryTable.innerHTML = '';
            drugInventory.forEach(drug => {
                const row = inventoryTable.insertRow();
                row.innerHTML = `
                    <td>${drug.id}</td>
                    <td>${drug.name}</td>
                    <td>${drug.category}</td>
                    <td>${drug.quantity}</td>
                    <td>₦${drug.price.toFixed(2)}</td>
                    <td>
                        <button class="action-btn btn-edit"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-delete"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                
                // Add event listeners to buttons
                row.querySelector('.btn-edit').addEventListener('click', () => openEditDrugModal(drug.id));
                row.querySelector('.btn-delete').addEventListener('click', () => showConfirmModal(drug.id, 'drug'));
            });
        }

        // Update pharmacy transactions table
        function updatePharmacyTable() {
            pharmacyTable.innerHTML = '';
            pharmacyTransactions.forEach(transaction => {
                const row = pharmacyTable.insertRow();
                
                // Get drug names for display
                const drugNames = transaction.drugs.map(drug => {
                    return `${drug.name} (${drug.quantity})`;
                }).join(', ');
                
                row.innerHTML = `
                    <td>${transaction.id}</td>
                    <td>${transaction.buyerName}</td>
                    <td>${drugNames}</td>
                    <td>₦${transaction.totalAmount.toFixed(2)}</td>
                    <td>${transaction.processedBy}</td>
                    <td>${transaction.date}</td>
                    <td><span class="status-badge ${getStatusClass(transaction.status)}">${transaction.status}</span></td>
                    <td>
                        <button class="action-btn btn-process" title="View Receipt"><i class="fas fa-receipt"></i></button>
                        <button class="action-btn btn-edit"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-delete"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                
                // Add event listeners to buttons
                const buttons = row.querySelectorAll('button');
                buttons[0].addEventListener('click', () => generateReceipt(transaction.id));
                buttons[1].addEventListener('click', () => openEditTransactionModal(transaction.id));
                buttons[2].addEventListener('click', () => showConfirmModal(transaction.id, 'transaction'));
            });
        }

        // Get status class for badge
        function getStatusClass(status) {
            switch(status) {
                case 'Completed': return 'status-active';
                case 'Pending': return 'status-pending';
                default: return 'status-completed';
            }
        }

        // Update summary counters
        function updateSummaryCounters() {
            totalDrugs.textContent = drugInventory.length;
            
            const today = new Date().toISOString().split('T')[0];
            const todayTransactions = pharmacyTransactions.filter(t => t.date === today && t.status === 'Completed');
            const todayTotal = todayTransactions.reduce((sum, t) => sum + t.totalAmount, 0);
            todaySales.textContent = `₦${todayTotal.toFixed(2)}`;
            
            const lowStockItems = drugInventory.filter(d => d.quantity < 20).length;
            lowStock.textContent = lowStockItems;
            
            const pendingCount = pharmacyTransactions.filter(t => t.status === 'Pending').length;
            pendingOrders.textContent = pendingCount;
        }

        // Populate drug select dropdown
        function populateDrugSelect() {
            const drugSelect = document.getElementById('drugs');
            drugSelect.innerHTML = '';
            
            drugInventory.forEach(drug => {
                const option = document.createElement('option');
                option.value = drug.id;
                option.textContent = `${drug.name} (₦${drug.price.toFixed(2)})`;
                option.setAttribute('data-price', drug.price);
                drugSelect.appendChild(option);
            });
            
            // Initialize Select2 again after updating options
            $(drugSelect).select2();
            
            // Add event listener for drug selection changes
            $(drugSelect).on('change', function() {
                updateSelectedDrugsList();
                calculateTotalAmount();
            });
        }

        // Update selected drugs list with quantities
        function updateSelectedDrugsList() {
            const selectedDrugsList = document.getElementById('selectedDrugsList');
            selectedDrugsList.innerHTML = '';
            
            const selectedOptions = document.getElementById('drugs').selectedOptions;
            selectedDrugs = [];
            
            for (let option of selectedOptions) {
                const drugId = option.value;
                const drug = drugInventory.find(d => d.id === drugId);
                if (drug) {
                    // Add to selected drugs array with default quantity 1
                    selectedDrugs.push({
                        id: drug.id,
                        name: drug.name,
                        price: drug.price,
                        quantity: 1
                    });
                    
                    // Create row in the table
                    const row = document.createElement('tr');
                    row.dataset.drugId = drug.id;
                    row.innerHTML = `
                        <td>${drug.name}</td>
                        <td><input type="number" min="1" value="1" class="drug-quantity" data-price="${drug.price}"></td>
                        <td><input type="number" min="0" step="0.01" value="${drug.price.toFixed(2)}" class="drug-price"></td>
                        <td class="drug-subtotal">₦${drug.price.toFixed(2)}</td>
                        <td><i class="fas fa-times remove-drug"></i></td>
                    `;
                    selectedDrugsList.appendChild(row);
                }
            }
            
            // Add event listeners to quantity and price inputs
            document.querySelectorAll('.drug-quantity').forEach(input => {
                input.addEventListener('change', function() {
                    updateDrugQuantity(this);
                    calculateTotalAmount();
                });
            });
            
            document.querySelectorAll('.drug-price').forEach(input => {
                input.addEventListener('change', function() {
                    updateDrugPrice(this);
                    calculateTotalAmount();
                });
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-drug').forEach(icon => {
                icon.addEventListener('click', function() {
                    removeDrug(this);
                });
            });
        }

        // Update drug quantity in the selected drugs array
        function updateDrugQuantity(input) {
            const row = input.closest('tr');
            const drugId = row.dataset.drugId;
            const quantity = parseInt(input.value) || 1;
            const price = parseFloat(row.querySelector('.drug-price').value) || 0;
            
            // Update the selected drugs array
            const drugIndex = selectedDrugs.findIndex(d => d.id === drugId);
            if (drugIndex !== -1) {
                selectedDrugs[drugIndex].quantity = quantity;
                selectedDrugs[drugIndex].price = price;
            }
            
            // Update the subtotal
            const subtotal = quantity * price;
            row.querySelector('.drug-subtotal').textContent = `₦${subtotal.toFixed(2)}`;
        }

        // Update drug price in the selected drugs array
        function updateDrugPrice(input) {
            const row = input.closest('tr');
            const drugId = row.dataset.drugId;
            const price = parseFloat(input.value) || 0;
            const quantity = parseInt(row.querySelector('.drug-quantity').value) || 1;
            
            // Update the selected drugs array
            const drugIndex = selectedDrugs.findIndex(d => d.id === drugId);
            if (drugIndex !== -1) {
                selectedDrugs[drugIndex].price = price;
                selectedDrugs[drugIndex].quantity = quantity;
            }
            
            // Update the subtotal
            const subtotal = quantity * price;
            row.querySelector('.drug-subtotal').textContent = `₦${subtotal.toFixed(2)}`;
        }

        // Remove drug from selection
        function removeDrug(icon) {
            const row = icon.closest('tr');
            const drugId = row.dataset.drugId;
            
            // Remove from selected drugs array
            selectedDrugs = selectedDrugs.filter(d => d.id !== drugId);
            
            // Remove from Select2 selection
            const select = document.getElementById('drugs');
            const option = Array.from(select.options).find(o => o.value === drugId);
            if (option) {
                option.selected = false;
                $(select).trigger('change');
            }
            
            // Remove row from table
            row.remove();
            
            // Recalculate total
            calculateTotalAmount();
        }

        // Calculate total amount
        function calculateTotalAmount() {
            totalAmount = selectedDrugs.reduce((sum, drug) => sum + (drug.quantity * drug.price), 0);
            document.getElementById('totalAmount').value = totalAmount.toFixed(2);
        }

        // Generate receipt - FIXED VERSION
        function generateReceipt(transactionId) {
            const transaction = pharmacyTransactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            const receiptContent = document.getElementById('receiptContent');
            const today = new Date().toLocaleDateString();
            const time = new Date().toLocaleTimeString();
            
            // Generate drugs list HTML
            let drugsList = '';
            let drugsTotal = 0;
            
            // Make sure we're using transaction.drugs (array of objects)
            transaction.drugs.forEach(drug => {
                const subtotal = drug.quantity * drug.price;
                drugsList += `
                    <tr>
                        <td>${drug.name}</td>
                        <td>${drug.quantity}</td>
                        <td>₦${drug.price.toFixed(2)}</td>
                        <td>₦${subtotal.toFixed(2)}</td>
                    </tr>
                `;
                drugsTotal += subtotal;
            });
            
            receiptContent.innerHTML = `
                <div class="receipt-header">
                    <h3>Hospital Pharmacy</h3>
                    <p>123 Medical Center Drive, Lagos</p>
                    <p>Tel: +234 801 234 5678</p>
                    <p>Transaction #: ${transaction.id}</p>
                    <p>Date: ${today} ${time}</p>
                </div>
                
                <div class="receipt-details">
                    <p><strong>Buyer:</strong> ${transaction.buyerName}</p>
                    <p><strong>Processed By:</strong> ${transaction.processedBy}</p>
                    
                    <table class="table table-sm mt-3">
                        <thead>
                            <tr>
                                <th>Drug</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${drugsList}
                        </tbody>
                    </table>
                </div>
                
                <div class="receipt-footer">
                    <p>Total: ₦${drugsTotal.toFixed(2)}</p>
                    <p>Thank you for your patronage!</p>
                </div>
            `;
            
            receiptModal.style.display = 'block';
        }

        // Open add transaction modal
        function openAddTransactionModal() {
            isEditMode = false;
            document.getElementById('transactionModalTitle').textContent = 'New Pharmacy Transaction';
            document.getElementById('saveTransactionBtn').textContent = 'Process Transaction';
            transactionForm.reset();
            document.getElementById('transactionId').value = '';
            document.getElementById('transactionDate').valueAsDate = new Date();
            document.getElementById('selectedDrugsList').innerHTML = '';
            document.getElementById('totalAmount').value = '0.00';
            $('.drug-select').val(null).trigger('change');
            transactionModal.style.display = 'block';
        }

        // Open edit transaction modal
        function openEditTransactionModal(transactionId) {
            const transaction = pharmacyTransactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            isEditMode = true;
            currentRow = transaction;
            document.getElementById('transactionModalTitle').textContent = 'Edit Transaction';
            document.getElementById('saveTransactionBtn').textContent = 'Update Transaction';
            
            // Fill form with transaction data
            document.getElementById('transactionId').value = transaction.id;
            document.getElementById('buyerName').value = transaction.buyerName;
            document.getElementById('processedBy').value = transaction.processedBy;
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('totalAmount').value = transaction.totalAmount.toFixed(2);
            
            // Set selected drugs
            const drugSelect = document.getElementById('drugs');
            transaction.drugs.forEach(drug => {
                const option = Array.from(drugSelect.options).find(o => o.value === drug.id);
                if (option) option.selected = true;
            });
            
            // Trigger Select2 change to update the UI
            $(drugSelect).trigger('change');
            
            // Manually set the selected drugs array
            selectedDrugs = JSON.parse(JSON.stringify(transaction.drugs));
            
            // Update the drugs table
            const selectedDrugsList = document.getElementById('selectedDrugsList');
            selectedDrugsList.innerHTML = '';
            
            selectedDrugs.forEach(drug => {
                const row = document.createElement('tr');
                row.dataset.drugId = drug.id;
                row.innerHTML = `
                    <td>${drug.name}</td>
                    <td><input type="number" min="1" value="${drug.quantity}" class="drug-quantity" data-price="${drug.price}"></td>
                    <td><input type="number" min="0" step="0.01" value="${drug.price.toFixed(2)}" class="drug-price"></td>
                    <td class="drug-subtotal">₦${(drug.quantity * drug.price).toFixed(2)}</td>
                    <td><i class="fas fa-times remove-drug"></i></td>
                `;
                selectedDrugsList.appendChild(row);
            });
            
            // Add event listeners to quantity and price inputs
            document.querySelectorAll('.drug-quantity').forEach(input => {
                input.addEventListener('change', function() {
                    updateDrugQuantity(this);
                    calculateTotalAmount();
                });
            });
            
            document.querySelectorAll('.drug-price').forEach(input => {
                input.addEventListener('change', function() {
                    updateDrugPrice(this);
                    calculateTotalAmount();
                });
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-drug').forEach(icon => {
                icon.addEventListener('click', function() {
                    removeDrug(this);
                });
            });
            
            transactionModal.style.display = 'block';
        }

        // Open add drug modal
        function openAddDrugModal() {
            isEditMode = false;
            document.getElementById('drugModalTitle').textContent = 'Add New Drug';
            document.getElementById('saveDrugBtn').textContent = 'Save Drug';
            drugForm.reset();
            document.getElementById('drugId').value = '';
            drugModal.style.display = 'block';
        }

        // Open edit drug modal
        function openEditDrugModal(drugId) {
            const drug = drugInventory.find(d => d.id === drugId);
            if (!drug) return;
            
            isEditMode = true;
            currentDrugRow = drug;
            document.getElementById('drugModalTitle').textContent = 'Edit Drug';
            document.getElementById('saveDrugBtn').textContent = 'Update Drug';
            
            // Fill form with drug data
            document.getElementById('drugId').value = drug.id;
            document.getElementById('drugName').value = drug.name;
            document.getElementById('drugCategory').value = drug.category;
            document.getElementById('drugQuantity').value = drug.quantity;
            document.getElementById('drugPrice').value = drug.price;
            
            drugModal.style.display = 'block';
        }

        // Show confirmation modal
        function showConfirmModal(id, type) {
            recordToDelete = { id, type };
            confirmModal.style.display = 'block';
        }

        // Close modal
        function closeModal() {
            transactionModal.style.display = 'none';
            drugModal.style.display = 'none';
            receiptModal.style.display = 'none';
            confirmModal.style.display = 'none';
        }

        // Confirm delete
        function confirmDelete() {
            if (!recordToDelete) return;
            
            if (recordToDelete.type === 'drug') {
                // Delete drug from inventory
                drugInventory = drugInventory.filter(d => d.id !== recordToDelete.id);
                updateInventoryTable();
            } else if (recordToDelete.type === 'transaction') {
                // Delete transaction
                pharmacyTransactions = pharmacyTransactions.filter(t => t.id !== recordToDelete.id);
                updatePharmacyTable();
            }
            
            updateSummaryCounters();
            closeModal();
        }

        // Event Listeners
        addTransactionBtn.addEventListener('click', openAddTransactionModal);
        addDrugBtn.addEventListener('click', openAddDrugModal);
        closeBtns.forEach(btn => btn.addEventListener('click', closeModal));
        cancelTransactionBtn.addEventListener('click', closeModal);
        cancelDrugBtn.addEventListener('click', closeModal);
        closeReceiptBtn.addEventListener('click', closeModal);
        printReceiptBtn.addEventListener('click', () => window.print());
        confirmCancel.addEventListener('click', closeModal);
        document.getElementById('confirmDelete').addEventListener('click', confirmDelete);
        
        // Transaction form submission
        transactionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const transactionId = document.getElementById('transactionId').value || `TR${String(nextTransactionId++).padStart(3, '0')}`;
            const buyerName = document.getElementById('buyerName').value;
            const processedBy = document.getElementById('processedBy').value;
            const totalAmount = parseFloat(document.getElementById('totalAmount').value);
            const date = document.getElementById('transactionDate').value;
            
            // Get selected drugs with quantities and prices
            const selectedDrugsWithDetails = selectedDrugs.map(drug => {
                return {
                    id: drug.id,
                    name: drugInventory.find(d => d.id === drug.id)?.name || drug.name,
                    quantity: drug.quantity,
                    price: drug.price
                };
            });
            
            if (isEditMode) {
                // Update existing transaction
                const index = pharmacyTransactions.findIndex(t => t.id === transactionId);
                if (index !== -1) {
                    pharmacyTransactions[index] = { 
                        id: transactionId, 
                        buyerName, 
                        drugs: selectedDrugsWithDetails, 
                        totalAmount, 
                        processedBy, 
                        date, 
                        status: 'Completed' 
                    };
                }
            } else {
                // Add new transaction
                pharmacyTransactions.push({ 
                    id: transactionId, 
                    buyerName, 
                    drugs: selectedDrugsWithDetails, 
                    totalAmount, 
                    processedBy, 
                    date, 
                    status: 'Completed' 
                });
            }
            
            // Store the last transaction ID for receipt generation
            lastTransactionId = transactionId;
            
            updatePharmacyTable();
            updateSummaryCounters();
            closeModal();
            
            // Generate and show receipt for the correct transaction
            generateReceipt(transactionId);
        });
        
        // Drug form submission
        drugForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const drugId = document.getElementById('drugId').value || `DR${String(nextDrugId++).padStart(3, '0')}`;
            const name = document.getElementById('drugName').value;
            const category = document.getElementById('drugCategory').value;
            const quantity = parseInt(document.getElementById('drugQuantity').value);
            const price = parseFloat(document.getElementById('drugPrice').value);
            
            if (isEditMode) {
                // Update existing drug
                const index = drugInventory.findIndex(d => d.id === drugId);
                if (index !== -1) {
                    drugInventory[index] = { id: drugId, name, category, quantity, price };
                }
            } else {
                // Add new drug
                drugInventory.push({ id: drugId, name, category, quantity, price });
            }
            
            updateInventoryTable();
            updateSummaryCounters();
            populateDrugSelect();
            closeModal();
        });
        
        // Search functionality
        searchInput.addEventListener('keyup', function() {
            const filter = this.value.toLowerCase();
            const rows = pharmacyTable.getElementsByTagName('tr');
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                let match = false;
                
                for (let j = 0; j < cells.length; j++) {
                    if (cells[j].textContent.toLowerCase().includes(filter)) {
                        match = true;
                        break;
                    }
                }
                
                row.style.display = match ? '' : 'none';
            }
        });
        
        // Initialize sales chart
        const ctx = document.getElementById('salesChart').getContext('2d');
        const salesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Monthly Sales (₦)',
                    data: [120000, 190000, 150000, 180000, 200000, 220000],
                    backgroundColor: '#6c5ce7'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Initialize with sample data
        initializeSampleData();
    </script>
</body>
</html>